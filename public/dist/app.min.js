angular.module("statesGame",["ui.router","ngAnimate","ngSanitize","ui.bootstrap"]),angular.module("statesGame").config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/",templateUrl:"../partials/home.html",controller:"HomeController",controllerAs:"home"}).state("game",{url:"/game/:id",templateUrl:"../partials/game.html",controller:"GameController",controllerAs:"game"}),t.otherwise("/")}]),angular.module("statesGame").controller("GameController",["$stateParams","MapService","$state","$rootScope","ModalService","$scope",function(e,t,a,o,n,r){angular.isString(e.id)&&e.id.length>0?t.initialize(e.id):a.go("home");var i=o.$on("finishedGame",function(e,t){n.openModal({title:"Finished game",body:t},function(){a.go("home")})});r.$on("$destroy",function(){i()})}]),angular.module("statesGame").controller("HomeController",["$state","$timeout",function(e,t){var a=this;a.countries=["Australia","Brazil","Canada","USA"],a.selected="";var o=angular.element("#country-select");a.startGame=function(){angular.isString(a.selected)&&a.selected.length>0?e.go("game",{id:a.selected.toLowerCase()}):(o.focus(),o.addClass("shake"),t(function(){o.removeClass("shake")},200))}}]),angular.module("statesGame").service("MapService",["Questionnaire","$rootScope","$timeout","$state",function(e,t,a,o){function n(e){switch(d=d3.select("#svg-container").append("svg").attr("class","map").attr("width",f).attr("height",h),p=["Australia","Brazil","Canada","United States of America"],e){case"australia":c(0);break;case"brazil":c(1);break;case"canada":c(2);break;case"usa":c(3);break;default:o.go("home")}}function r(e){return"Australia"==e?b:"Brazil"==e?$:"Canada"==e?g:"United States of America"==e?v:v}function i(t,a){d3.json("../data/provincies.json",function(o,n){if(o)return console.error(o);var r=n.objects.new_lakes.geometries.slice();e.showQuestionnaire(r,a),d.selectAll("*").remove(),d.selectAll(".subunit").data(topojson.feature(n,n.objects.new_lakes).features).enter().append("path").attr("class",function(e,t){var o=e.properties.admin==a?"":" hidden";return"subunit "+e.id+o}).attr("fill","#ccc").attr("stroke","#212121").on("mouseover",function(){d3.select(this).attr("fill","#777").style("transition","fill .5s ease-in")}).on("mouseout",function(){d3.select(this).attr("fill","#ccc").style("transition","fill .5s ease-out")}).on("click",function(t){e.checkAnswer(t.properties.name,this,d3.event.pageX,d3.event.pageY)}).attr("d",t),m=d3.select("body").append("div").attr("class","tooltip").style("opacity",0)})}function s(e,t,a){m.transition().duration(200).style("opacity",.9),m.html(a).style("left",e+"px").style("top",t-28+"px")}function l(){m.transition().duration(500).style("opacity",0)}function c(e){angular.element("#task").html("");var t=p[e],a=r(t),o=d3.geoPath().projection(a);i(o,t)}var u=this;u.initialize=n,u.showTooltip=s,u.hideTooltip=l;var d,m,p,f=960,h=800,g=d3.geoAzimuthalEquidistant().scale(900).rotate([110,-60]).clipAngle(179.999).translate([350,450]).precision(.1),v=d3.geoAlbersUsa().scale(1e3).translate([f/2,h/2]),$=d3.geoAzimuthalEquidistant().scale(900).rotate([50,30]).clipAngle(179.999).translate([500,600]).precision(.1),b=d3.geoAzimuthalEquidistant().scale(900).rotate([-135,60]).clipAngle(179.999).translate([500,900]).precision(.1),y=t.$on("showTooltip",function(e,t){u.showTooltip(t._x,t._y,t._name),a(function(){u.hideTooltip()},1500)});return t.$on("$destroy",function(){y()}),u}]),angular.module("statesGame").controller("ModalCtrl",["$uibModalInstance","content",function(e,t){var a=this;a.content=t,a.ok=function(){e.close()}}]),angular.module("statesGame").service("ModalService",["$uibModal",function(e){var t=this;return t.openModal=function(t,a){var o=e.open({templateUrl:"../partials/modal.html",controller:"ModalCtrl",controllerAs:"modal",size:"md",resolve:{content:function(){return{title:t.title,body:t.body}}}});o.result.then(function(){a()},function(){a()})},t}]),angular.module("statesGame").service("Questionnaire",["$rootScope","$timeout",function(e,t){function a(e){var t,a,o;for(o=e.length;o;o--)t=Math.floor(Math.random()*o),a=e[o-1],e[o-1]=e[t],e[t]=a}function o(e,t){for(var o=[],n=0;n<e.length;n++)if(e[n].properties.admin===t){if("Jervis Bay Territory"===e[n].properties.name)continue;if("District of Columbia"===e[n].properties.name)continue;e[n].id=e[n].id.replace(/\./,"-"),o.push(e[n])}a(o),p=o.slice(),l=p.length,i()}function n(t,a,o,n){u>=l||(f=p[u].properties.name,t===f?(d[f]?1==d[f]?(d[f]=2,d3.select(a).classed("true-region",!1),d3.select(a).classed("second-attempt",!0)):2==d[f]?(d[f]=3,d3.select(a).classed("true-region",!1),d3.select(a).classed("third-attempt",!0)):d[f]>=3&&(d[f]=4,d3.select(a).classed("true-region",!1),d3.select(a).classed("fourth-attempt",!0)):(d[f]=1,d3.select(a).classed("true-region",!1),d3.select(a).classed("first-attempt",!0)),u++,i()):(e.$broadcast("showTooltip",{_x:o,_y:n,_name:t}),m++,d[f]?(d[f]+=1,d[f]>=4&&(d[f]=4,d3.select("."+p[u].id).classed("true-region",!0))):d[f]=1))}function r(e){var t,a=0,o={1:100,2:67,3:33,4:0};for(var n in e){var r=e[n];a+=o[r]}return t=a/Object.size(e)}function i(){u<l?angular.element("#task").html("Click on "+p[u].properties.name):s()}function s(){var a=r(d);d={},m=0,u=0,t(function(){e.$broadcast("finishedGame","You Win! Your score is "+a+"%")},1e3)}var l,c=this,u=0,d={},m=0,p=[],f="";return c.showQuestionnaire=o,c.checkAnswer=n,Object.size=function(e){var t,a=0;for(t in e)e.hasOwnProperty(t)&&a++;return a},c}]);